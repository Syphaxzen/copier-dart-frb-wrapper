---
name: update-{{ package_name }}
description: Update {{ native_library_name }} native library version. Use when checking for updates, upgrading {{ native_library_name }}, bumping version, or updating native dependencies.
---

# Update {{ native_library_name }} Version

Guide for updating the {{ native_library_name }} native library version in this project.

## Review Automated PR (Most Common)

When the CI creates an automated PR for {{ native_library_name }} update, follow these steps:

### Step 1: Analyze Release Notes

```bash
# Fetch and read release notes
gh api repos/{{ native_repo }}/releases/tags/vX.Y.Z --jq '.body'
```

Look for:
- **Breaking changes** (API removals, signature changes)
- **New features** (new APIs exposed)
- **Security fixes**

### Step 2: Check Why Codegen Failed (if applicable)

```bash
# Check if Rust code compiles
make rust-check
```

Common issues:
- **Removed traits** (e.g., `Ord` for `PublicKey` in v0.87.0)
- **Changed function signatures**
- **Renamed types**

### Step 3: Fix Rust Code (if needed)

If `make rust-check` fails, fix the errors in `rust/src/api/`:
- Update code to match new {{ native_library_name }} API
- Add workarounds for removed functionality

### Step 4: Regenerate FRB Bindings

```bash
make codegen
```

### Step 5: Run Tests

```bash
make test
```

### Step 6: Run Analysis

```bash
make analyze
```

### Step 7: Update CHANGELOG.md

Verify AI-generated entry is accurate. Update if needed:
- Fix incorrect descriptions
- Add details about breaking changes and workarounds
- Ensure `{{ crate_name }}` version is mentioned in Highlights

### Step 8: Bump {{ crate_name }} Version

Edit `rust/Cargo.toml`:
```toml
version = "X.Y.Z"  # Bump patch for deps, minor for new features
```

Update CHANGELOG.md Highlights:
```markdown
- **{{ native_library_name }} vX.Y.Z** — description
- **{{ crate_name }} vX.Y.Z** — Rust FFI bindings
```

### Step 9: Sync Cargo.lock

```bash
make rust-check
```

### Step 10: Commit Changes

```bash
git add rust/Cargo.toml rust/Cargo.lock rust/src/api/ lib/src/rust/ CHANGELOG.md
git commit -m "fix(keys): adapt for {{ native_library_name }} vX.Y.Z breaking changes"
```

### Checklist Summary

- [ ] Read release notes for breaking changes
- [ ] Fix Rust compilation errors (if any)
- [ ] `make codegen` — regenerate FRB bindings
- [ ] `make test` — all tests pass
- [ ] `make analyze` — no issues
- [ ] CHANGELOG.md — accurate description
- [ ] `rust/Cargo.toml` — bump `{{ crate_name }}` version
- [ ] `make rust-check` — sync Cargo.lock
- [ ] Commit all changes

---

## Quick Update (Automatic)

```bash
# Check for updates
make check

# Check and apply updates automatically
make check ARGS="--update"
```

This will:
1. Check GitHub for latest {{ native_library_name }} release
2. Update `pubspec.yaml` with new `{{ package_name }}.native_version`

## Manual Update Process

### Step 1: Check Current Version

```bash
make version
```

Or check `pubspec.yaml`:
```yaml
{{ package_name }}:
  native_version: "X.Y.Z"  # Current version
```

### Step 2: Update Version

Edit `pubspec.yaml`:
```yaml
{{ package_name }}:
  native_version: "X.Y.Z"  # New version
```

### Step 3: Regenerate FFI Bindings

```bash
make codegen
```

This downloads the new {{ native_library_name }} headers and regenerates FFI bindings.

### Step 4: Run Tests

```bash
make test
```

### Step 5: Commit Changes

```bash
git add pubspec.yaml lib/src/bindings/ CHANGELOG.md
git commit -m "Update {{ native_library_name }} to X.Y.Z"
git push
```

CI will automatically build native libraries for all platforms.

## Check Options

```bash
# Just check (no changes)
make check

# Check and update
make check ARGS="--update"

# Update to specific version
make check ARGS="--update --version X.Y.Z"

# Force update even if already up to date
make check ARGS="--update --force"

# JSON output for CI
make check ARGS="--ci"
```

## Version Locations

Files automatically updated by `make check ARGS="--update"`:

| File | What | Description |
|------|------|-------------|
| `pubspec.yaml` | native_version | Native library version |
| `README.md` | Badge | Version badge in header |
| `CLAUDE.md` | Example | Code example in documentation |
| `.claude/skills/update-{{ package_name }}/SKILL.md` | Example | Code example in skill |

Files that need manual update:

| File | What | Description |
|------|------|-------------|
| `pubspec.yaml` | `version` | Dart package version (bump if needed) |
| `CHANGELOG.md` | Entry | Document the version change |

## After CI Builds

When CI completes after pushing:

1. Native libraries are built for all platforms
2. Artifacts are combined
3. SHA256 checksums created for verification
4. GitHub Release created with assets

## Troubleshooting

### "No updates available"
- You're already on the latest version
- Check https://github.com/{{ github_repo }}/releases

### "Binding generation failed"
- New {{ native_library_name }} version may have breaking API changes
- Check {{ native_library_name }} release notes
- May need to update wrapper code in `lib/src/`

### Tests fail after update
- API may have changed
- Check if function signatures changed
- Review {{ native_library_name }} changelog for breaking changes

## Upstream Resources

- [{{ native_library_name }} Releases](https://github.com/{{ github_repo }}/releases)
- [{{ native_library_name }} Repository](https://github.com/{{ github_repo }})
